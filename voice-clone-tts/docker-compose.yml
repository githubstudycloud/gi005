# ============================================================
# Voice Clone TTS Docker Compose 配置
# v3.1 微服务架构
# ============================================================
#
# 使用方法:
#   启动服务:  docker-compose up -d
#   查看日志:  docker-compose logs -f
#   停止服务:  docker-compose down
#
# 注意: 首次启动需要下载模型，可能需要较长时间
# ============================================================

version: '3.8'

services:
  # 网关服务
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: voice-clone-tts:latest
    container_name: voice-clone-gateway
    restart: unless-stopped

    ports:
      - "8080:8080"

    volumes:
      - ./voices:/app/voices
      - ./logs:/app/logs

    environment:
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8080
      - LOG_LEVEL=INFO

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - voice-clone-net

    command: ["python", "-m", "src.main", "gateway", "--port", "8080"]

  # XTTS-v2 工作节点
  xtts-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: voice-clone-tts:latest
    container_name: voice-clone-xtts
    restart: unless-stopped
    depends_on:
      - gateway

    # GPU 支持 (需要 nvidia-docker)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ports:
      - "8001:8001"

    volumes:
      # 音色存储（持久化）
      - ./voices:/app/voices
      # 日志目录
      - ./logs:/app/logs
      # 模型目录（挂载本地模型避免重复下载）
      - ../packages/models/xtts_v2/extracted:/app/models/xtts:ro

    environment:
      - DEVICE=cuda
      - LOG_LEVEL=INFO

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # 模型加载需要时间

    networks:
      - voice-clone-net

    command: ["python", "-m", "src.main", "worker", "--engine", "xtts", "--port", "8001", "--gateway", "http://gateway:8080", "--auto-load"]

  # OpenVoice 工作节点 (可选)
  openvoice-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: voice-clone-tts:latest
    container_name: voice-clone-openvoice
    restart: unless-stopped
    depends_on:
      - gateway
    profiles:
      - openvoice  # 使用 --profile openvoice 启动

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ports:
      - "8002:8002"

    volumes:
      - ./voices:/app/voices
      - ./logs:/app/logs
      - ../packages/models/openvoice/extracted:/app/models/openvoice:ro

    environment:
      - DEVICE=cuda
      - LOG_LEVEL=INFO

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - voice-clone-net

    command: ["python", "-m", "src.main", "worker", "--engine", "openvoice", "--port", "8002", "--gateway", "http://gateway:8080", "--auto-load"]

  # GPT-SoVITS 工作节点 (可选，需要外部 API 服务)
  gpt-sovits-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: voice-clone-tts:latest
    container_name: voice-clone-gpt-sovits
    restart: unless-stopped
    depends_on:
      - gateway
    profiles:
      - gpt-sovits  # 使用 --profile gpt-sovits 启动

    ports:
      - "8003:8003"

    volumes:
      - ./voices:/app/voices
      - ./logs:/app/logs

    environment:
      - GPT_SOVITS_API_URL=http://host.docker.internal:9880
      - LOG_LEVEL=INFO

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - voice-clone-net

    command: ["python", "-m", "src.main", "worker", "--engine", "gpt-sovits", "--port", "8003", "--gateway", "http://gateway:8080"]

  # CPU 版本 (无 GPU)
  xtts-worker-cpu:
    build:
      context: .
      dockerfile: Dockerfile
    image: voice-clone-tts:latest
    container_name: voice-clone-cpu
    restart: unless-stopped
    depends_on:
      - gateway
    profiles:
      - cpu  # 使用 --profile cpu 启动

    ports:
      - "8001:8001"

    volumes:
      - ./voices:/app/voices
      - ./logs:/app/logs
      - ../packages/models/xtts_v2/extracted:/app/models/xtts:ro

    environment:
      - DEVICE=cpu
      - LOG_LEVEL=INFO

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s  # CPU 模式加载更慢

    networks:
      - voice-clone-net

    command: ["python", "-m", "src.main", "worker", "--engine", "xtts", "--port", "8001", "--gateway", "http://gateway:8080", "--device", "cpu", "--auto-load"]

networks:
  voice-clone-net:
    driver: bridge

# ============================================================
# 使用示例:
#
# 1. 启动网关 + XTTS 工作节点 (默认):
#    docker-compose up -d gateway xtts-worker
#
# 2. 启动 OpenVoice 工作节点:
#    docker-compose --profile openvoice up -d openvoice-worker
#
# 3. 启动 CPU 版本 (无 GPU):
#    docker-compose --profile cpu up -d gateway xtts-worker-cpu
#
# 4. 启动所有服务:
#    docker-compose --profile openvoice --profile gpt-sovits up -d
#
# 5. 查看日志:
#    docker-compose logs -f gateway xtts-worker
#
# 6. 停止所有服务:
#    docker-compose down
# ============================================================
