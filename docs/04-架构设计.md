# 04 架构设计

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Clients                               │
│         (Browser / curl / Python / Mobile)                   │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    Gateway (FastAPI)                         │
│                       Port: 8080                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ 路由分发  │ │ 限流控制  │ │ 服务注册  │ │ WebSocket │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└────────────────────────────┬────────────────────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ XTTS Worker  │    │OpenVoice    │    │GPT-SoVITS   │
│   :8001      │    │ Worker:8002 │    │ Worker:8003 │
└──────────────┘    └──────────────┘    └──────────────┘
```

---

## 核心模块

### Gateway (网关)

| 文件 | 职责 |
|------|------|
| `gateway/app.py` | FastAPI 应用、路由、Web 页面 |
| `gateway/registry.py` | 服务注册、心跳、负载均衡 |
| `gateway/limiter.py` | 限流 (TokenBucket + SlidingWindow) |
| `gateway/websocket.py` | WebSocket 实时状态推送 |

### Workers (工作节点)

| 文件 | 职责 |
|------|------|
| `workers/base_worker.py` | 抽象基类、生命周期管理 |
| `workers/xtts_worker.py` | XTTS-v2 引擎实现 |
| `workers/openvoice_worker.py` | OpenVoice 引擎实现 |
| `workers/gpt_sovits_worker.py` | GPT-SoVITS API 代理 |

### Common (公共)

| 文件 | 职责 |
|------|------|
| `common/models.py` | Pydantic 数据模型 |
| `common/paths.py` | 路径配置 |
| `common/exceptions.py` | 自定义异常 |
| `common/logging.py` | 日志系统 |

---

## 服务通信

### 节点注册流程

```
Worker 启动 → POST /api/register → Gateway 记录
    ↓
每 10 秒 → POST /api/heartbeat → 更新状态
    ↓
Worker 关闭 → POST /api/unregister → 移除节点
```

### 请求处理流程

```
Client → Gateway → Registry (选择节点) → Worker → 返回结果
```

---

## 负载均衡

支持三种策略:
- `round_robin`: 轮询 (默认)
- `least_load`: 最少负载
- `random`: 随机

---

## 限流配置

| 层级 | 默认值 | 说明 |
|------|--------|------|
| 全局 | 1000 RPM | 系统总请求限制 |
| IP | 100 RPM | 单 IP 请求限制 |
| 并发 | 50 | 最大同时处理数 |

---

## 配置文件

`config.yaml`:

```yaml
gateway:
  host: "0.0.0.0"
  port: 8080
  global_rpm: 1000
  ip_rpm: 100
  heartbeat_interval: 10
  dead_threshold: 30

workers:
  xtts:
    port: 8001
    device: "cuda"
  openvoice:
    port: 8002
    device: "cuda"
  gpt_sovits:
    port: 8003
    api_url: "http://127.0.0.1:9880"

logging:
  level: "INFO"
  file: "logs/voice-clone.log"
```

---

## 目录结构

```
voice-clone-tts/
├── src/
│   ├── main.py               # CLI 入口
│   ├── common/               # 公共模块
│   ├── gateway/              # 网关模块
│   └── workers/              # 工作节点
├── voices/                   # 音色存储
├── logs/                     # 日志目录
├── config.yaml               # 配置文件
├── requirements.txt          # 依赖
├── Dockerfile
└── docker-compose.yml
```

---

## 下一步

- API 详情 → [05-API参考](05-API参考.md)
- 部署指南 → [02-安装部署](02-安装部署.md)
