# 02 安装部署

## 系统要求

### 硬件

| 配置 | CPU | 内存 | 显卡 | 存储 |
|------|-----|------|------|------|
| 最低 | 4核 | 8GB | 无 | 10GB |
| 推荐 | 8核 | 16GB | 6GB+ | 20GB |

### 软件

- Python 3.10.x
- FFmpeg 5.0+
- CUDA 11.8+ (GPU 加速)

---

## 安装步骤

### 1. 安装 Python

**Windows:**
```powershell
# 下载 Python 3.10: https://www.python.org/downloads/
# 安装时勾选 "Add Python to PATH"
python --version  # 验证
```

**Linux:**
```bash
sudo apt install python3.10 python3.10-venv python3-pip
```

### 2. 创建虚拟环境

```bash
cd voice-clone-tts
python -m venv venv

# 激活
venv\Scripts\activate     # Windows
source venv/bin/activate  # Linux
```

### 3. 安装依赖

```bash
# 在线安装
pip install -r requirements.txt

# GPU 版本
pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu118

# 国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 4. 还原模型文件

模型以分卷压缩包存储在 `packages/models/`:

```bash
# XTTS-v2 (~2GB)
cd packages/models/xtts_v2
cat xtts_v2_full.pkg.part_* > xtts_v2.tar
tar -xvf xtts_v2.tar -C extracted/

# OpenVoice (~130MB)
cd ../openvoice
cat checkpoints_v2.pkg.part_* > checkpoints.tar
tar -xvf checkpoints.tar -C extracted/

# Whisper (~1.5GB, 可选)
cd ../whisper
cat whisper_models.pkg.part_* > whisper.tar
tar -xvf whisper.tar -C extracted/

# FFmpeg
cd ../../tools
cat ffmpeg.pkg.part_* > ffmpeg.tar
tar -xvf ffmpeg.tar -C extracted/
```

### 5. 验证安装

```bash
# 测试导入
python -c "
import torch
print(f'PyTorch: {torch.__version__}')
print(f'CUDA: {torch.cuda.is_available()}')
"

# 测试路径配置
python -c "from src.common.paths import verify_model_paths; print(verify_model_paths())"
```

---

## 启动服务

### 单机模式 (开发/测试)

```bash
python -m src.main standalone --engine xtts --port 8080
```

### 分布式模式 (生产)

```bash
# 终端 1: 网关
python -m src.main gateway --port 8080

# 终端 2: XTTS Worker
python -m src.main worker --engine xtts --port 8001 \
  --gateway http://localhost:8080 --auto-load

# 终端 3: OpenVoice Worker (可选)
python -m src.main worker --engine openvoice --port 8002 \
  --gateway http://localhost:8080
```

### Docker 部署

```bash
docker-compose up -d gateway xtts-worker
docker-compose logs -f
```

---

## 目录结构

```
packages/
├── models/
│   ├── xtts_v2/
│   │   ├── *.pkg.part_*      # 分卷压缩包
│   │   └── extracted/        # 解压后模型
│   ├── openvoice/
│   │   ├── *.pkg.part_*
│   │   └── extracted/
│   └── whisper/
│       ├── *.pkg.part_*
│       └── extracted/
├── tools/
│   ├── *.pkg.part_*          # FFmpeg
│   └── extracted/
└── repos/                    # 外部仓库 (GPT-SoVITS)
```

---

## 下一步

- 使用方法 → [03-使用指南](03-使用指南.md)
- 常见问题 → [06-常见问题](06-常见问题.md)
